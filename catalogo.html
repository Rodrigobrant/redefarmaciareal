<script>
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTPFvGL_R8uI0miwFf-ApxEfOsqIMiLv4px-xkHTbkmRhvyUgsF9eJlxTJXi7mCX2x7vFKfEoBJ3TLN/pub?gid=608567924&single=true&output=csv";
  const whatsappNumero = "5575998623295"; // Número da farmácia no formato internacional

  // Função para parsear CSV respeitando aspas e vírgulas nos campos
  function parseCSV(text) {
    const linhas = text.split('\n');
    return linhas.map(linha => {
      const resultado = [];
      let campo = '';
      let dentroAspas = false;
      for (let i = 0; i < linha.length; i++) {
        const char = linha[i];
        if (char === '"' && linha[i+1] !== '"') {
          dentroAspas = !dentroAspas;
        } else if (char === ',' && !dentroAspas) {
          resultado.push(campo);
          campo = '';
        } else {
          campo += char;
        }
      }
      resultado.push(campo);
      return resultado;
    });
  }

  function formatarPreco(precoStr) {
    precoStr = precoStr.replace(/"/g, '').replace(/\s/g, '').replace('R$', '');
    let valor = precoStr.replace(',', '.');
    valor = parseFloat(valor);
    if (isNaN(valor)) return "Preço indisponível";
    return 'R$ ' + valor.toFixed(2).replace('.', ',');
  }

  async function carregarProdutos() {
    const response = await fetch(url);
    const data = await response.text();
    const linhas = parseCSV(data).slice(1); // Ignora cabeçalho
    const grid = document.getElementById("produtos");

    linhas.forEach(colunas => {
      if (colunas.length < 5) return;

      const produto = {
        nome: colunas[0].trim(),
        descricao: colunas[1].trim(),
        preco: colunas[2].trim(),
        imagem: colunas[3] ? colunas[3].trim() : "imagens/placeholder.png"
      };

      const card = document.createElement("div");
      card.className = "card";

      const img = document.createElement("img");
      img.src = produto.imagem && produto.imagem !== "" ? produto.imagem : "imagens/placeholder.png";
      img.alt = produto.nome;

      const nome = document.createElement("h3");
      nome.textContent = produto.nome;

      const descricao = document.createElement("p");
      descricao.textContent = produto.descricao;

      const price = document.createElement("p");
      price.className = "price";
      price.textContent = formatarPreco(produto.preco);

      const botao = document.createElement("a");
      botao.className = "whatsapp-btn";
      const mensagem = encodeURIComponent(`Olá! Gostaria de comprar ${produto.nome} - ${price.textContent}`);
      botao.href = `https://wa.me/${whatsappNumero}?text=${mensagem}`;
      botao.target = "_blank";
      botao.textContent = "Comprar no WhatsApp";

      card.appendChild(img);
      card.appendChild(nome);
      card.appendChild(descricao);
      card.appendChild(price);
      card.appendChild(botao);

      grid.appendChild(card);
    });
  }

  carregarProdutos();

  document.getElementById("search").addEventListener("input", function () {
    const termo = this.value.toLowerCase();
    const cards = document.querySelectorAll(".card");
    cards.forEach(card => {
      const nome = card.querySelector("h3").textContent.toLowerCase();
      card.style.display = nome.includes(termo) ? "block" : "none";
    });
  });
</script>
